#!/usr/bin/env bash
# Wrapper for simplefinsetup that loads .env file
# This allows using SIMPLEFIN_SETUP_TOKEN from .env

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load environment variables from .env if it exists
if [ -f "$PROJECT_ROOT/.env" ]; then
    set -a  # Enable allexport mode
    source "$PROJECT_ROOT/.env"
    set +a  # Disable allexport mode
fi

# Load environment from load-env helper if available
if [ -f "$SCRIPT_DIR/load-env" ]; then
    source "$SCRIPT_DIR/load-env" "$PROJECT_ROOT/.env" 2>/dev/null || true
fi

# If SIMPLEFIN_SETUP_TOKEN is not set, prompt for it
if [ -z "$SIMPLEFIN_SETUP_TOKEN" ]; then
    echo "SIMPLEFIN_SETUP_TOKEN not found in environment or .env file" >&2
    echo "Please paste your SimpleFIN Setup Token:" >&2
    read -r SIMPLEFIN_SETUP_TOKEN
    export SIMPLEFIN_SETUP_TOKEN
fi

# Run the original simplefinsetup script
exec "$SCRIPT_DIR/simplefinsetup.orig"
