#!/usr/bin/env bash
# Wrapper for simplefinjson that loads .env file
# This allows using SIMPLEFIN_ACCESS_URL from .env
#
# Usage: simplefinjson [OPTIONS] [ACCTID]
#
# Options:
#  --transactions       Include transactions from last 30 days (shortcut)
#  --start-date DAYS    Number of days to look back
#  --end-date TIMESTAMP Unix epoch timestamp for end date
#  --pending            Include pending transactions
#  --balances-only      Return only balances, no transactions
#  --account ACCTID     Specific account ID (can be specified multiple times)
#  --help               Show this help message
#
# Default behavior (no options):
#  Returns account info and balances WITHOUT transaction history (fast).
#  Use --transactions or --start-date to include transactions.
#
# Examples:
#  simplefinjson                           # All accounts, balances only (NEW DEFAULT)
#  simplefinjson --transactions            # All accounts with last 30 days
#  simplefinjson --start-date 90           # All accounts, last 90 days
#  simplefinjson --pending                 # Include pending transactions
#  simplefinjson --account ACT-123456      # Specific account only
#  simplefinjson ACT-123456                # Same as above (positional)
#  simplefinjson --balances-only           # Just balances, no transactions

set -e

# Show help if requested before loading env
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    grep '^#' "$0" | sed 's/^# \?//'
    exit 0
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load environment variables from .env if it exists
if [ -f "$PROJECT_ROOT/.env" ]; then
    set -a  # Enable allexport mode
    source "$PROJECT_ROOT/.env"
    set +a  # Disable allexport mode
fi

# Load environment from load-env helper if available
if [ -f "$SCRIPT_DIR/load-env" ]; then
    source "$SCRIPT_DIR/load-env" "$PROJECT_ROOT/.env" 2>/dev/null || true
fi

# Check if SIMPLEFIN_ACCESS_URL is set
if [ -z "$SIMPLEFIN_ACCESS_URL" ]; then
    echo "Error: SIMPLEFIN_ACCESS_URL not found in environment or .env file" >&2
    echo "Please run 'simplefinsetup' first to configure SimpleFIN access" >&2
    exit 1
fi

# Run the original simplefinjson script with all arguments
exec "$SCRIPT_DIR/simplefinjson.orig" "$@"
